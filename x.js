macros={};macros["at"]=function (arr,i){if(((current_target=="lua")&&is_number(i))){i=(i+1);}else if((current_target=="lua")){i=["+",i,1];}return(["get",arr,i]);};macros["across"]=function (args){var body=Array.prototype.slice.call(arguments,1);var l=args[0];var v=args[1];var i=(args[2]||make_unique());var o=(args[3]||0);var l1=make_unique();return(["do",["local",i,o],["local",l1,l],join(["while",["<",i,["length",l1]],["local",v,["at",l1,i]],],join(body,[["set",i,["+",i,1]]]))]);};macros["make-set"]=function (){var elements=Array.prototype.slice.call(arguments,0);var form=["table"];var _1=0;var _2=elements;while((_1<length(_2))){var x=_2[_1];push(form,x);push(form,true);_1=(_1+1);}return(form);};current_target="js";macros["current-language"]=function (){return(("\""+current_target+"\""));};macros["target"]=function (){var clauses=Array.prototype.slice.call(arguments,0);var _3=0;var _4=clauses;while((_3<length(_4))){var clause=_4[_3];if((clause[0]==current_target)){return(clause[1]);}_3=(_3+1);}};function length(x){return(x.length);}function sub(x,from,upto){if(is_string(x)){return(x.substring(from,upto));}else{return(x.slice(from,upto));}}function push(arr,x){arr[length(arr)]=x;}function join(a1,a2){return(a1.concat(a2));}function char(str,n){return(str.charAt(n));}function find(str,pattern,start){var i=str.indexOf(pattern,start);return(((i>0)&&i));}fs=require("fs");function read_file(path){return(fs.readFileSync(path,"utf8"));}function write_file(path,data){return(fs.writeFileSync(path,data,"utf8"));}function print(x){return(console.log(x));}function write(x){return(process.stdout.write(x));}function exit(code){return(process.exit(code));}function is_string(x){return((type(x)=="string"));}function is_string_literal(x){return((is_string(x)&&(char(x,0)=="\"")));}function is_number(x){return((type(x)=="number"));}function is_boolean(x){return((type(x)=="boolean"));}function is_composite(x){return((type(x)=="object"));}function is_atom(x){return(!(is_composite(x)));}function is_table(x){return((is_composite(x)&&(x[0]==undefined)));}function is_list(x){return((is_composite(x)&&!((x[0]==undefined))));}function parse_number(str){var n=parseFloat(str);if(!(isNaN(n))){return(n);}}function to_string(x){if((x==undefined)){return("nil");}else if(is_boolean(x)){if(x){return("true");}else{return("false");}}else if(is_atom(x)){return((x+""));}else{var str="(";var i=0;var _5=x;while((i<length(_5))){var y=_5[i];str=(str+to_string(y));if((i<(length(x)-1))){str=(str+" ");}i=(i+1);}return((str+")"));}}function error(msg){throw(msg);return(undefined);}function type(x){return(typeof(x));}function apply(f,args){return(f.apply(f,args));}unique_counter=0;function make_unique(prefix){unique_counter=(unique_counter+1);return(("_"+(prefix||"")+unique_counter));}eval_result=undefined;delimiters={"(":true,")":true,";":true,"\n":true};eof={};delimiters[eof]=true;whitespace={" ":true,"\t":true,"\n":true};function make_stream(str){return({pos:0,string:str,len:length(str)});}function peek_char(s){if((s.pos<s.len)){return(char(s.string,s.pos));}else{return(eof);}}function read_char(s){var c=peek_char(s);if(c){s.pos=(s.pos+1);return(c);}}function skip_non_code(s){while(true){var c=peek_char(s);if(!(c)){break;}else if(whitespace[c]){read_char(s);}else if((c==";")){while((c&&!((c=="\n")))){c=read_char(s);}skip_non_code(s);}else{break;}}}function read_symbol(s){var str="";while(true){var c=peek_char(s);if((c&&(!(whitespace[c])&&!(delimiters[c])))){str=(str+c);read_char(s);}else{break;}}return(str);}function read_atom(s){var str=read_symbol(s);var n=parse_number(str);if((n==undefined)){return(str);}else{return(n);}}function read_list(s){read_char(s);var l=[];while(true){skip_non_code(s);var c=peek_char(s);if((c&&!((c==")")))){push(l,read(s));}else if(c){read_char(s);break;}else{error(("Expected ) at "+s.pos));}}return(l);}function read_string(s){read_char(s);var str="\"";while(true){var c=peek_char(s);if((c&&!((c=="\"")))){if((c=="\\")){str=(str+read_char(s));}str=(str+read_char(s));}else if(c){read_char(s);break;}else{error(("Expected \" at "+s.pos));}}return((str+"\""));}function read_quote(s){read_char(s);return(["quote",read(s)]);}function read_unquote(s){read_char(s);if((peek_char(s)=="@")){read_char(s);return(["unquote-splicing",read(s)]);}else{return(["unquote",read(s)]);}}function read_eof(s){return(read_char(s));}function read_close_paren_error(s){return(error(("Unexpected ) at "+s.pos)));}read_table={"(":read_list,")":read_close_paren_error,"\"":read_string,"'":read_quote,",":read_unquote,"":read_atom};read_table[eof]=read_eof;function read(s){skip_non_code(s);var c=peek_char(s);var f=(read_table[c]||read_table[""]);return(f(s));}function read_from_string(str){return(read(make_stream(str)));}operators={"common":{"+":"+","-":"-","*":"*","/":"/","<":"<",">":">","=":"==","<=":"<=",">=":">="},"js":{"and":"&&","or":"||","cat":"+"},"lua":{"and":" and ","or":" or ","cat":".."}};is_preserve_macros=true;function get_op(op){return((operators["common"][op]||operators[current_target][op]));}function is_call(type,form){if(!(is_list(form))){return(false);}else if((type=="operator")){return(!((get_op(form[0])==undefined)));}else if((type=="special")){return(!((special[form[0]]==undefined)));}else if((type=="macro")){return(!((macros[form[0]]==undefined)));}else{return(false);}}function compile_args(forms,is_compile){var str="(";var i=0;var _6=forms;while((i<length(_6))){var x=_6[i];var x1=(function (){if(is_compile){return(compile(x));}else{return(normalize(x));}})();str=(str+x1);if((i<(length(forms)-1))){str=(str+",");}i=(i+1);}return((str+")"));}function compile_body(forms,is_tail){var str="";var i=0;var _7=forms;while((i<length(_7))){var x=_7[i];var is_t=(is_tail&&(i==(length(forms)-1)));str=(str+compile(x,true,is_t));i=(i+1);}return(str);}function normalize(id){var id2="";var i=0;while((i<length(id))){var c=char(id,i);if((c=="-")){c="_";}id2=(id2+c);i=(i+1);}var last=(length(id)-1);if((char(id,last)=="?")){var name=sub(id2,0,last);id2=("is_"+name);}return(id2);}function compile_atom(form){if((form=="nil")){if((current_target=="js")){return("undefined");}else{return("nil");}}else if((is_string(form)&&!(is_string_literal(form)))){return(normalize(form));}else{return(to_string(form));}}function compile_call(form){var fn=form[0];var fn1=compile(fn);var args=compile_args(sub(form,1),true);if(is_list(fn)){return(("("+fn1+")"+args));}else if(is_string(fn)){return((fn1+args));}else{return(error("Invalid function call"));}}function compile_operator(form){var str="(";var op=get_op(form[0]);var i=1;var _8=form;while((i<length(_8))){var arg=_8[i];str=(str+compile(arg));if((i<(length(form)-1))){str=(str+op);}i=(i+1);}return((str+")"));}function compile_do(forms,is_tail){return(compile_body(forms,is_tail));}function compile_set(form){if((length(form)<2)){error("Missing right-hand side in assignment");}var lh=compile(form[0]);var rh=compile(form[1]);return((lh+"="+rh));}function compile_branch(condition,body,is_first,is_last,is_tail){var cond1=compile(condition);var body1=compile(body,true,is_tail);var tr=(function (){if((is_last&&(current_target=="lua"))){return(" end ");}else{return("");}})();if((is_first&&(current_target=="js"))){return(("if("+cond1+"){"+body1+"}"));}else if(is_first){return(("if "+cond1+" then "+body1+tr));}else if(((condition==undefined)&&(current_target=="js"))){return(("else{"+body1+"}"));}else if((condition==undefined)){return((" else "+body1+" end "));}else if((current_target=="js")){return(("else if("+cond1+"){"+body1+"}"));}else{return((" elseif "+cond1+" then "+body1+tr));}}function compile_if(form,is_tail){var str="";var i=0;var _9=form;while((i<length(_9))){var condition=_9[i];var is_last=(i>=(length(form)-2));var is_else=(i==(length(form)-1));var is_first=(i==0);var body=form[(i+1)];if(is_else){body=condition;condition=undefined;}i=(i+1);str=(str+compile_branch(condition,body,is_first,is_last,is_tail));i=(i+1);}return(str);}function is_vararg(name){return((sub(name,(length(name)-3),length(name))=="..."));}function bind_arguments(args,body){var args1=[];var _10=0;var _11=args;while((_10<length(_11))){var arg=_11[_10];if(is_vararg(arg)){var name=sub(arg,0,(length(arg)-3));var expr=(function (){if((current_target=="js")){return(["Array.prototype.slice.call","arguments",length(args1)]);}else{push(args1,"...");return(["list","..."]);}})();body=join([["local",name,expr],],join(body,[]));break;}else{push(args1,arg);}_10=(_10+1);}return([args1,body]);}function compile_defun(form){var name=normalize(form[0]);var args=form[1];var body=sub(form,2);return(compile_function(args,body,name));}function compile_lambda(form){var args=form[0];var body=sub(form,1);return(compile_function(args,body));}function compile_function(args,body,name){name=(name||"");var expanded=bind_arguments(args,body);var args1=compile_args(expanded[0]);var body1=compile_body(expanded[1],true);if((current_target=="js")){return(("function "+name+args1+"{"+body1+"}"));}else{return(("function "+name+args1+body1+" end "));}}function compile_get(form){var object=compile(form[0]);var key=compile(form[1]);if(((current_target=="lua")&&(char(object,0)=="{"))){object=("("+object+")");}return((object+"["+key+"]"));}function compile_dot(form){var object=compile(form[0]);var key=normalize(form[1]);return((object+"."+key));}function compile_not(form){var expr=compile(form[0]);var open=(function (){if((current_target=="js")){return("!(");}else{return("(not ");}})();return((open+expr+")"));}function compile_local(form){var lh=compile(form[0]);var keyword=(function (){if((current_target=="js")){return("var ");}else{return("local ");}})();if((form[1]==undefined)){return((keyword+lh));}else{var rh=compile(form[1]);return((keyword+lh+"="+rh));}}function compile_while(form){var condition=compile(form[0]);var body=compile_body(sub(form,1));if((current_target=="js")){return(("while("+condition+"){"+body+"}"));}else{return(("while "+condition+" do "+body+" end "));}}function compile_list(forms,is_quoted){var open=(function (){if((current_target=="lua")){return("{");}else{return("[");}})();var close=(function (){if((current_target=="lua")){return("}");}else{return("]");}})();var str="";var i=0;var _12=forms;while((i<length(_12))){var x=_12[i];if((is_list(x)&&(x[0]=="unquote-splicing"))){var x1=compile(x[1]);var x2=compile_list(sub(forms,(i+1)),true);open=("join("+open);close=(close+",join("+x1+","+x2+"))");break;}else{var x1=(function (){if(is_quoted){return(quote_form(x));}else{return(compile(x));}})();str=(str+x1);if((i<(length(forms)-1))){str=(str+",");}}i=(i+1);}return((open+str+close));}function compile_table(forms){var sep=(function (){if((current_target=="lua")){return("=");}else{return(":");}})();var str="{";var i=0;while((i<(length(forms)-1))){var k=compile(forms[i]);var v=compile(forms[(i+1)]);if(((current_target=="lua")&&is_string_literal(k))){k=("["+k+"]");}str=(str+k+sep+v);if((i<(length(forms)-2))){str=(str+",");}i=(i+2);}return((str+"}"));}function compile_each(forms){var args=forms[0];var t=args[0];var k=args[1];var v=args[2];var body=sub(forms,1);if((current_target=="lua")){var body1=compile_body(body);var t1=compile(t);return(("for "+k+","+v+" in pairs("+t1+") do "+body1+" end"));}else{var body1=compile_body(join([["set",v,["get",t,k]],],join(body,[])));return(("for("+k+" in "+t+"){"+body1+"}"));}}macros["unquote"]=function (){return(error("UNQUOTE not inside QUOTE"));};macros["unquote-splicing"]=function (){return(error("UNQUOTE-SPLICING not inside QUOTE"));};function compile_to_string(form){if(is_string_literal(form)){var str=sub(form,1,(length(form)-1));return(("\"\\\""+str+"\\\"\""));}else if(is_string(form)){return(("\""+form+"\""));}else{return(to_string(form));}}function quote_form(form){if(is_atom(form)){return(compile_to_string(form));}else if((form[0]=="unquote")){return(compile(form[1]));}else{return(compile_list(form,true));}}function compile_quote(forms){return(quote_form(forms[0]));}function compile_defmacro(form){var name=form[0];var lambda=join(["lambda",],join(sub(form,1),[]));var register=["set",["get","macros",compile_to_string(name)],lambda];var compiled=compile_for_target("js",register,true);eval(compiled);if(!(is_preserve_macros)){return("");}else if(!(("js"==current_target))){return(compile(register,true));}else{return(compiled);}}function compile_special(form,is_stmt,is_tail){var name=form[0];var sp=special[name];if((!(is_stmt)&&sp["stmt?"])){return(compile([["lambda",[],form]],false,is_tail));}else{var is_tr=(is_stmt&&!(sp["self-tr"]));var tr=(function (){if(is_tr){return(";");}else{return("");}})();var fn=sp["compiler"];return((fn(sub(form,1),is_tail)+tr));}}special={"do":{"compiler":compile_do,"self-tr":true,"stmt?":true},"if":{"compiler":compile_if,"self-tr":true,"stmt?":true},"while":{"compiler":compile_while,"self-tr":true,"stmt?":true},"defun":{"compiler":compile_defun,"self-tr":true,"stmt?":true},"defmacro":{"compiler":compile_defmacro,"self-tr":true,"stmt?":true},"local":{"compiler":compile_local,"stmt?":true},"set":{"compiler":compile_set,"stmt?":true},"each":{"compiler":compile_each,"stmt?":true},"get":{"compiler":compile_get},"dot":{"compiler":compile_dot},"not":{"compiler":compile_not},"list":{"compiler":compile_list},"table":{"compiler":compile_table},"quote":{"compiler":compile_quote},"lambda":{"compiler":compile_lambda}};function is_can_return(form){if(is_call("macro",form)){return(false);}else if(is_call("special",form)){return(!(special[form[0]]["stmt?"]));}else{return(true);}}function compile(form,is_stmt,is_tail){var tr=(function (){if(is_stmt){return(";");}else{return("");}})();if((is_tail&&is_can_return(form))){form=["return",form];}if((form==undefined)){return("");}else if(is_atom(form)){return((compile_atom(form)+tr));}else if(is_call("operator",form)){return((compile_operator(form)+tr));}else if(is_call("special",form)){return(compile_special(form,is_stmt,is_tail));}else if(is_call("macro",form)){var fn=macros[form[0]];var form=apply(fn,sub(form,1));return(compile(form,is_stmt,is_tail));}else{return((compile_call(form)+tr));}}function compile_file(file){var form;var output="";var s=make_stream(read_file(file));while(true){form=read(s);if((form==eof)){break;}output=(output+compile(form,true));}return(output);}function compile_files(files){var output="";var _13=0;var _14=files;while((_13<length(_14))){var file=_14[_13];output=(output+compile_file(file));_13=(_13+1);}return(output);}function compile_for_target(target){var args=Array.prototype.slice.call(arguments,1);var previous_target=current_target;current_target=target;var result=apply(compile,args);current_target=previous_target;return(result);}passed=0;function assert_equal(a,b){var sa=to_string(a);var sb=to_string(b);if(!((sa==sb))){return(error((" failed: expected "+sa+" was "+sb)));}else{passed=(passed+1);}}function run_tests(){print(" running tests...");assert_equal(18,18);assert_equal(123,123);assert_equal(0.123,0.123);assert_equal(17,(16+1));assert_equal(4,(7-3));assert_equal(5,(10/2));assert_equal(6,(2*3));assert_equal(true,!(false));assert_equal(true,(true||false));assert_equal(false,(true&&false));assert_equal(17,(function (){if(true){return(17);}else{return(18);}})());assert_equal(18,(function (){if(false){return(17);}else{return(18);}})());assert_equal("foo","foo");assert_equal("\"bar\"","\"bar\"");assert_equal(1,length("\""));assert_equal(2,length("a\""));assert_equal("foobar",("foo"+"bar"));assert_equal(2,length(("\""+"\"")));assert_equal("a","a");assert_equal("a","a");assert_equal("a",char("bar",1));assert_equal("uu",sub("quux",1,3));assert_equal([],[]);assert_equal([1],[1]);assert_equal(["a"],["a"]);assert_equal(["a"],["a"]);assert_equal(false,(["a"]==["\"a\""]));assert_equal(5,length([1,2,3,4,5]));assert_equal(3,length([1,[2,3,4],5]));assert_equal(3,length([1,[2,3,4],5][1]));var a="bar";assert_equal([1,2,"bar"],[1,2,a]);assert_equal([["bar"]],[[a]]);assert_equal(false,("\"a\""=="a"));assert_equal(false,(["a"]==["\"a\""]));assert_equal(["a",[2,3,7,"b"]],["a",[2,3,7,"b"]]);assert_equal([1,2,3],join([1],[2,3]));assert_equal([1,2,3,4],join([1],join([2],[3,4])));a=[2,3];assert_equal([1,2,3,4],join([1,],join(a,[4])));assert_equal([1,2,3,4],join([1,],join([2,3],[4])));assert_equal([1,2,3],join([1,],join(a,[])));assert_equal([2,3],join([],join(a,[])));assert_equal(4,eval(compile(["+",2,2])));assert_equal("foo",eval(compile(["quote","foo"])));assert_equal([2,3],apply(join,[[2],[3]]));apply(assert_equal,[4,4]);var f=function (x){return((x+1));};assert_equal(2,f(1));assert_equal(3,apply(function (a,b){return((a+b));},[1,2]));assert_equal([1,2],apply(function (){var a=Array.prototype.slice.call(arguments,0);return(a);},[1,2]));assert_equal([[1,2]],apply(function (){var a=Array.prototype.slice.call(arguments,0);return([a]);},[1,2]));assert_equal([1,2],apply(function (){var a=Array.prototype.slice.call(arguments,0);return(join([],join(a,[])));},[1,2]));f=function (){var a=Array.prototype.slice.call(arguments,0);return(a);};assert_equal(["a","b"],f("a","b"));assert_equal(42,(function (){return(42);})());var t={};t["foo"]=17;assert_equal({foo:17},t);t["bar"]=42;assert_equal({foo:17,"bar":42},t);var s={a:true,b:true,c:true};assert_equal(true,s["a"]);assert_equal(true,s["c"]);assert_equal(undefined,s["x"]);var x=0;var l=[1,2,3,4,5];var _15=0;var _16=l;while((_15<length(_16))){var v=_16[_15];x=(x+v);_15=(_15+1);}assert_equal(x,15);var l2=[];var i=0;var _17=l;while((i<length(_17))){var v=_17[i];l2[i]=v;i=(i+1);}assert_equal(l,l2);x=0;t={foo:10,bar:100};for(k in t){v=t[k];if((k=="foo")){x=(x+v+1);}else{x=(x+v+10);}};assert_equal(x,121);return(print((" "+passed+" passed")));}function eval_string(str){var form=read_from_string(str);return(eval(compile_for_target("js",form)));}function interactive(){var execute=function (str){print(to_string(eval_string(str)));return(write("> "));};write("> ");process.stdin.resume();process.stdin.setEncoding("utf8");return(process.stdin.on("data",execute));}args=sub(process.argv,2);function usage(){print("usage: x [<inputs>] [-o <output>] [-l <language>] [-e <expr>]");return(exit());}if(((args[0]=="-h")||(args[0]=="--help"))){usage();}var inputs=[];var output=undefined;var expr=undefined;var i=0;var _18=args;while((i<length(_18))){var arg=_18[i];if(((arg=="-o")||(arg=="-l")||(arg=="-e"))){if((i==(length(args)-1))){print("missing argument for",arg);}else{i=(i+1);var arg2=args[i];if((arg=="-o")){output=arg2;}else if((arg=="-l")){current_target=arg2;}else if((arg=="-e")){expr=arg2;}}}else if(("-"==sub(arg,0,1))){print("unrecognized option:",arg);usage();}else{push(inputs,arg);}i=(i+1);}var compiled=compile_files(inputs);if(output){write_file(output,compiled);}else{eval(compiled);if(expr){print(to_string(eval_string(expr)));}else{interactive();}}